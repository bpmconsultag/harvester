---
# Example playbook: Clean up Harvester resources
- name: Delete Harvester resources
  hosts: localhost
  gather_facts: false
  vars:
    # Harvester settings will be loaded from .env file


  pre_tasks:
    - name: Load Harvester settings from environment variables (use dotenv to export before running)
      set_fact:
        harvesterpy_host: "{{ lookup('ansible.builtin.env', 'HARVESTER_HOST') }}"
        harvesterpy_token: "{{ lookup('ansible.builtin.env', 'HARVESTER_TOKEN') }}"
        harvester_namespace: "{{ lookup('ansible.builtin.env', 'HARVESTER_NAMESPACE') | default('default') }}"
        harvester_verify_ssl: "{{ lookup('ansible.builtin.env', 'HARVESTER_VERIFY_SSL') | default('true') }}"
  
  tasks:
    - name: Delete virtual machine
      harvester_vm:
        host: "{{ harvesterpy_host }}"
        token: "{{ harvesterpy_token }}"
        name: "my-ubuntu-vm"
        namespace: "{{ harvester_namespace }}"
        state: absent
      register: vm_delete_result
      ignore_errors: true

    - name: Delete volume
      harvester_volume:
        host: "{{ harvesterpy_host }}"
        token: "{{ harvesterpy_token }}"
        name: "my-vm-disk"
        namespace: "{{ harvester_namespace }}"
        state: absent
      register: volume_delete_result
      ignore_errors: true

    - name: Delete image
      harvester_image:
        host: "{{ harvesterpy_host }}"
        token: "{{ harvesterpy_token }}"
        name: "ubuntu-20.04"
        namespace: "{{ harvester_namespace }}"
        state: absent
      register: image_delete_result
      ignore_errors: true

    - name: Display cleanup results
      debug:
        msg: "Cleanup completed"
